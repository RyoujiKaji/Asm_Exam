### Организация подпрограмм в архитектуре x86

Подпрограмма (процедура) — это логически завершенный блок команд, который описывается один раз, но может быть вызван из любого места программы. Использование подпрограмм позволяет реализовать принцип модульности и экономить память.

#### 1. Объявление и структура подпрограммы

Для выделения блока команд в процедуру используются директивы `PROC` (начало) и `ENDP` (конец).

- **Синтаксис:**
    
    Фрагмент кода
    
    ```
    имя_процедуры PROC [расстояние]
        ; Тело процедуры (команды)
        ret ; Обязательная команда возврата
    имя_процедуры ENDP
    ```
    
- **Атрибут расстояния:**
    
    - `NEAR` (ближняя): вызов внутри того же сегмента кода. В стек сохраняется только смещение (`EIP/RIP`).
        
    - `FAR` (дальняя): вызов из другого сегмента. В стек сохраняются и сегмент (`CS`), и смещение.
        

---

#### 2. Механизм вызова и возврата (CALL и RET)

Управление подпрограммами неразрывно связано с работой **стека**.

- **Команда CALL:**
    
    1. Сохраняет адрес следующей инструкции (адрес возврата) в стек.
        
    2. Загружает в указатель команд (`EIP/RIP`) адрес начала процедуры.
        
    
    - _Формы вызова:_ прямой (по имени), косвенный через регистр (`call rax`) или через переменную-указатель.
        
- **Команда RET:**
    
    1. Извлекает адрес возврата из вершины стека.
        
    2. Загружает его обратно в `EIP/RIP`, возвращаясь в точку после вызова.
        
    
    - _Важно:_ Если внутри процедуры данные были помещены в стек и не извлечены до `ret`, программа попытается «прыгнуть» по неверному адресу, что приведет к краху.
        

---

#### 3. Способы передачи параметров

Существует три основных подхода к передаче аргументов в подпрограмму:

А. Через регистры (Register Passing)

Наиболее быстрый способ. Параметры копируются в регистры перед вызовом.

- _Плюсы:_ Максимальная скорость.
    
- _Минусы:_ Ограниченное количество регистров.
    
- _Соглашения (x64 ABI):_ В Windows x64 первые 4 параметра передаются через `RCX, RDX, R8, R9`.
    

Б. Через стек (Stack Passing)

Самый универсальный способ. Параметры заталкиваются в стек командой PUSH.

- _Доступ:_ Внутри процедуры параметры извлекаются относительно регистра базы фрейма (`EBP/RBP`).
    
- _Очистка стека:_ Может выполняться вызывающей программой (`add esp, 4`) или самой процедурой (`ret 4`).
    

В. Через глобальные переменные

Данные помещаются в общую область памяти (.data).

- _Плюсы:_ Удобно для очень больших массивов или структур.
    
- _Минусы:_ Трудность отладки, риск непреднамеренного изменения данных другими частями программы.
    

---

#### 4. Фрейм стека и локальные переменные

Для изоляции данных процедуры создается **фрейм стека** (Stack Frame) с использованием регистра `EBP` (или `RBP`).

1. **Пролог (начало процедуры):**
    
    Фрагмент кода
    
    ```
    push ebp      ; Сохраняем базу предыдущей процедуры
    mov  ebp, esp ; Устанавливаем текущую базу
    sub  esp, 8   ; Резервируем место под локальные переменные (например, 8 байт)
    ```
    
2. **Эпилог (конец процедуры):**
    
    Фрагмент кода
    
    ```
    mov  esp, ebp ; Освобождаем локальные переменные
    pop  ebp      ; Восстанавливаем старую базу
    ret
    ```
    

- _Локальные переменные_ находятся по адресу `[ebp - смещение]`.
    
- _Входные аргументы_ находятся по адресу `[ebp + смещение]` (обычно начинаются с `[ebp + 8]` в x86, так как `[ebp+0]` — старый EBP, а `[ebp+4]` — адрес возврата).
    

---

#### 5. Возврат результата

Результат работы подпрограммы обычно передается обратно через:

- **Регистр EAX/RAX:** Для скалярных величин (числа, адреса).
    
- **Регистр ST(0):** Для чисел с плавающей точкой в FPU.
    
- **Стек или память:** Путем записи результата в ячейки, выделенные вызывающей стороной.
    

#### 6. Сохранение контекста

Поскольку процедура может изменять регистры, которые нужны вызывающей программе, хорошим тоном (или требованием ABI) является сохранение важных регистров в начале процедуры (`push`) и их восстановление в конце (`pop`). Согласно Microsoft x64 ABI, процедура обязана сохранять регистры `RBX, RBP, RDI, RSI, R12-R15`.