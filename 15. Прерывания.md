### **Прерывания (Interrupts)**

**Прерывание** — это механизм, при котором наступающее событие заставляет процессор принудительно приостановить текущую программу и передать управление специальной процедуре — **обработчику прерываний** (ISR — Interrupt Service Routine).

### **1. Классификация прерываний**

|**Вид прерывания**|**Источник**|**Особенности**|
|---|---|---|
|**Асинхронные (Аппаратные)**|Внешние устройства (таймер, клавиатура, диск).|Происходят в произвольный момент, не связаны с текущей командой.|
|**Синхронные (Исключения)**|Ошибки внутри процессора (деление на 0, ошибка защиты памяти).|Возникают непосредственно при попытке выполнить «неправильную» команду.|
|**Программные**|Инструкция в коде (например, `INT n`).|Намеренный вызов функций операционной системы (системные вызовы).|

---

### **2. Детальный механизм работы (Hardware Level)**

В отличие от обычного вызова подпрограммы (`CALL`), прерывание должно гарантировать полный возврат к исходному состоянию системы.

1. **Завершение текущей команды:** Процессор довыполняет текущую инструкцию.
    
2. **Сохранение флагов:** В стек автоматически помещается регистр **EFLAGS**. Это ключевое отличие от `CALL`.
    
3. **Сохранение адреса:** В стек помещаются сегментный регистр **CS** и указатель команд **EIP** (адрес возврата).
    
4. **Поиск обработчика:** Процессор обращается к **Таблице векторов прерываний** (IDT), находит адрес ISR по номеру прерывания и передает туда управление.
    
5. **Выполнение ISR:** Работает код обработчика.
    
6. **Возврат (IRET):** Специальная команда `IRET` извлекает из стека адрес возврата **и** восстанавливает регистр флагов.
    

---

### **3. Приоритеты и маскирование**

Прерывания могут иметь **приоритеты**: если одновременно приходят два сигнала, процессор выберет более важный (например, сигнал о сбое питания важнее нажатия клавиши).

- **Маскируемые прерывания:** Процессор может их временно игнорировать (команда `CLI` — сброс флага прерываний `IF`).
    
- **Немаскируемые (NMI):** Прерывания, которые нельзя игнорировать (критические сбои оборудования).
    

---

### **4. Практический пример: Системный вызов**

В реальном режиме работы (или в эмуляторах типа DOSBox) программные прерывания используются для вывода текста. Параметры передаются через регистры.

**Пример: Вывод строки на экран (MS-DOS API)**

Фрагмент кода

```
.data
    msg db 'Hello, Interrupts!', '$'  ; Строка, заканчивающаяся символом $

.code
main:
    mov ah, 09h             ; Номер функции DOS (печать строки) в AH
    mov dx, offset msg      ; Адрес строки в DX
    
    int 21h                 ; Вызов программного прерывания 21h
                            ; Процессор бросает текущий код, идет в ядро ОС,
                            ; печатает текст и возвращается по IRET сюда.

    mov ax, 4C00h           ; Функция завершения программы
    int 21h                 ; Снова прерывание для выхода в ОС
```

### **Резюме применения**

- **Драйверы:** Позволяют CPU не ждать медленное устройство, а реагировать только тогда, когда данные готовы.
    
- **Многозадачность:** Таймер генерирует прерывания каждые несколько миллисекунд, заставляя ОС переключать контекст между программами.
    
- **Защита:** Исключения позволяют ОС «убить» зависшее или некорректное приложение, не обрушив всю систему.