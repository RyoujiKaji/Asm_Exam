# **Директива ассемблера** (псевдооператор)
—  команда, которая даёт инструкции ассемблеру о том, как должна быть организована программа. Они не влияют на выполнение программы, но управляют процессом компиляции и связывания

### **1. Группа управления структурой и сегментацией**

Эти директивы ***определяют «каркас» программы***: её модель памяти, размер стека и границы логических разделов.

| Директива   | Назначение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Пример                    |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- |
| .MODEL      | Определяет [[5. Организация памяти. Модели памяти. Способы адресации#**Модель памяти**\|модель памяти]]. Должна находиться перед любой из директив объявления сегментов<br><br>***.MODEL \[модификатор] модель\_памяти \[,соглашение\_о\_вызовах] \[,тип\_ОС] \[,параметр\_стека]***<br><br>- Модификатор: `use16` (16-битные сегменты) или `use32` (32-битные сегменты).<br>- Соглашение о вызовах: Определяет способ передачи параметров (например, `C`, `PASCAL`, `STDCALL`).<br>- Тип ОС: По умолчанию `OS_DOS`.<br>- Параметр стека: `NEARSTACK` (стек и данные в одном сегменте, [[3. Функциональная и структурная организация процессора#**Сегментные регистры**\|SS=DS]]) или `FARSTACK` (в разных сегментах, SS≠DS). | `.MODEL FLAT, STDCALL`    |
| .STACK      | Резервирует область памяти под стек                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `.STACK 4096`             |
| .DATA       | Открывает сегмент инициализированных данных                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `.DATA`                   |
| .DATA?      | Открывает сегмент неинициализированных данных                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `.DATA?`                  |
| .CONST      | Открывает сегмент констант                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `.CONST`                  |
| .CODE       | Открывает сегмент с машинным кодом                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `.CODE`                   |
| PROC / ENDP | Обозначает начало и конец процедуры (функции)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `Main PROC ... Main ENDP` |
| END         | Конец исходного текста и указание точки входа                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `END Main`                |

### **2. Группа определения данных (Память)**

***Используются для выделения места в памяти*** ***под переменные*** разной разрядности.

***Директива описания данных имеет следующий формат:***

***\[<Имя>] <Директива>\[<Константа>DUP] \[(<Список инициализаторов>)]***

- <Имя> – имя поля данных, которое может не присваиваться;
- <Директива> – команда, объявляющая тип описываемых данных;
- <Константа> DUP – используются при описании повторяющихся данных, тогда константа определяет количество повторений;
- <Список инициализаторов> – последовательность инициализирующих констант, указанных через запятую, или символ «?», если инициализирующее значение не определяется.

В качестве инициализаторов при описании данных применяются:

- целые константы \[<знак>]<целое> \[<основание системы счисления>],
	-43236, 236d – целые десятичные числа,
	23h, 0ADh – целые шестнадцатеричные числа (если шестнадцатеричная константа начинается с буквы, то перед ней указывается 0),
	0111010b – целое двоичное;

- вещественные константы \[<знак>] <целое> . \[E|e \[<знак>] <целое>],
	например: -2., 34E-28;

- символы в кодировке ASCII (MS DOS) или ANSI (Windows) в апострофах или кавычках, например: 'A' или "A";

- строковые константы в апострофах или кавычках, например, 'ABCD' или "ABCD".

| Директива (полная) | Обозначение (краткое) | Размер           | Описание типа данных                                                              | Пример             |
| ------------------ | --------------------- | ---------------- | --------------------------------------------------------------------------------- | ------------------ |
| BYTE               | DB                    | 1 байт           | 8-разрядное целое (без знака — BYTE, со знаком — SBYTE) или строка                | `val1 DB 255`      |
| WORD               | DW                    | 2 байта          | 16-разрядное целое (без знака — WORD, со знаком — SWORD) или ближний указатель RM | `val2 DW 1234h`    |
| DWORD              | DD                    | 4 байта          | 32-разрядное целое (без знака — DWORD, со знаком — SDWORD) или ближний указатель  | `val3 DD 0`        |
| FWORD              | —                     | 6 bytes (48 bit) | 48-разрядное целое или дальний указатель                                          | `ptr_far FWORD ?`  |
| QWORD              | DQ                    | 8 байт           | 64-разрядное целое                                                                | `val4 DQ ?`        |
| TBYTE              | DT                    | 10 байт          | 80-разрядное целое или данные расширенной точности для FPU                        | `val5 DT 1.5`      |
| Real4              | —                     | 4 байта          | 32-х разрядное короткое вещественное число                                        | `f_val Real4 1.2`  |
| Real8              | —                     | 8 байт           | 64-х разрядное длинное вещественное число                                         | `d_val Real8 1.5`  |
| Real10             | —                     | 10 байт          | 80-ти разрядное расширенное вещественное число                                    | `e_val Real10 1.1` |
| —                  | DUP                   | —                | Оператор повторения данных; константа перед DUP определяет количество повторений  | `DB 100 DUP (0)`   |

### **3. Группа выбора архитектуры (Процессорная)**

***Указывает ассемблеру, команды какого поколения процессоров разрешено использовать.***

| Директива | Описание            | Доступные возможности              |
| --------- | ----------------------- | -------------------------------------- |
| .386      | Инструкции Intel 80386  | 32-битные регистры и адресация         |
| .486      | Инструкции Intel 80486  | Инструкции встроенного со-процессора   |
| .586      | Инструкции Pentium      | Расширенный набор команд IA-32         |
| .686      | Инструкции Pentium Pro  | Современные оптимизации команд         |
| .586P     | Привилегированный режим | Разрешает команды ядра ОС (LIDT, LGDT) |

### **4. Группа внешних связей (Модульная)**

***Используется, если программа состоит из нескольких файлов или подключает библиотеки.***

| Директива  | Назначение                               | Пример               |
| ---------- | -------------------------------------------- | ------------------------ |
| INCLUDE    | Вставка текста из другого файла              | `INCLUDE windows.inc`    |
| INCLUDELIB | Подключение библиотеки функций               | `INCLUDELIB user32.lib`  |
| PUBLIC     | Сделать переменную/процедуру доступной извне | `PUBLIC MyVar`           |
| EXTRN      | Описать символ, определенный в другом файле  | `EXTRN ExitProcess:PROC` |

# **Операторы ассемблера**
— специальные символы и ключевые слова, которые используются в выражениях для вычисления значений или изменения способа интерпретации данных **во время сборки** (а не во время работы программы).

Их можно разделить на несколько ключевых групп:

---

### 1. Операторы определения типов и атрибутов

Эти операторы позволяют управлять тем, как ассемблер воспринимает адрес или данные.

- **`PTR`**: Самый частый оператор. Переопределяет или уточняет размер операнда.
    
    - `mov AL, BYTE PTR [ebx]` — трактовать данные по адресу как байт.
        
- **`OFFSET`**: Возвращает адрес переменной относительно начала сегмента (статический адрес).
    
- **`TYPE`**: Возвращает размер типа переменной в байтах (например, для `DWORD` вернет 4).
    
- **`LENGTHOF`**: Возвращает количество элементов в массиве.
    
- **`SIZEOF`**: Возвращает общий размер массива в байтах (`LENGTHOF` * `TYPE`).
    

---

### 2. Арифметические и логические операторы

Используются для вычислений прямо в коде. Ассемблер сам посчитает результат и подставит число.

- **Стандартные**: `+`, `-`, `*`, `/`, `MOD` (остаток от деления).
    
    - `mov eax, 10 * 4` — ассемблер запишет `mov eax, 40`.
        
- **Сдвиги**: `SHL`, `SHR` (логический сдвиг влево/вправо).
    
- **Битовые**: `AND`, `OR`, `XOR`, `NOT`.
    

---

### 3. Операторы сравнения (для директив)

Обычно используются в условных директивах типа `IF` или `.IF`.

- **`EQ`** (равно), **`NE`** (не равно).
    
- **`LT`** (меньше), **`LE`** (меньше или равно).
    
- **`GT`** (больше), **`GE`** (больше или равно).
    

> **Важно:** Эти операторы работают во время компиляции. Для сравнения регистров в реальном времени используются команды `CMP` и условные переходы `JZ`, `JG` и т.д.

---

### 4. Специфические операторы сегментации и адресации

- **`SEG`**: Возвращает адрес сегмента переменной.
    
- **`SHORT`**: Указывает, что переход (JMP) будет коротким (в пределах -128...127 байт), что экономит место в коде.
    
- **`THIS`**: Позволяет создать метку с текущим адресом, но другим типом.
    
    - `W_Var EQU THIS WORD` перед `B_Var DB 2 DUP(0)` позволит обращаться к одним данным и как к байтам, и как к слову.
        

---

### 5. Операторы макросов и строк

Используются при написании макрокоманд:

- **`&` (Substitution)**: Подстановка параметра внутри строки.
    
- **`<>` (Literal-text)**: Трактует содержимое как одну текстовую строку.
    
- **`!` (Character)**: Позволяет использовать спецсимволы как обычный текст.
    
- **`%` (Expansion)**: Принудительно вычисляет выражение перед подстановкой.
    

### Краткая шпаргалка по приоритетам

Приоритет операторов в MASM схож с математическим:

1. Скобки `()` и квадратные скобки `[]`.
    
2. Операторы атрибутов (`PTR`, `OFFSET`, `TYPE`).
    
3. Умножение и деление.
    
4. Сложение и вычитание.
    

---

**Пример использования в коде:**

Фрагмент кода

```
.data
    myArray DWORD 10, 20, 30, 40

.code
    ; Использование TYPE и OFFSET
    mov eax, TYPE myArray       ; В EAX будет 4
    mov esi, OFFSET myArray     ; В ESI адрес начала массива
    
    ; Сложная адресация с арифметикой
    mov edx, [esi + (2 * TYPE myArray)] ; Достаем 30 (индекс 2)
```

> [!important] Разница между директивой, оператором и инструкцией
> - Директива (PROC, ENDP, .DATA, DB): Это команда для самого ассемблера (компилятора). Она, например, говорит ему: «Начни оформлять этот кусок кода как процедуру». Директивы не превращаются в машинный код напрямую, они лишь управляют процессом сборки.
> 
> - Оператор (OFFSET, PTR, TYPE): Это часть выражения. Он используется для вычисления каких-то значений или уточнения атрибутов во время компиляции.
> 
> - Инструкция (MOV, PUSH, CALL): Это то, что превращается в реальные байты машинного кода, которые исполняет процессор.
